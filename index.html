<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¢…èŠ±æ˜“æ•° Â· é“æ³•è‡ªç„¶</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- å±…ä¸­å›ºå®šå’Œé“å®¶ç„å¢¨é‡‘é£æ ¼ --- */
        :root {
            --color-ink-deep: #202a33;       /* ç„å¢¨æ·± (Primary Text/Background) */
            --color-gold-main: #c58c35;      /* éé‡‘ä¸»è‰² (Accent) */
            --color-cinnabar: #B22222;       /* æœ±ç ‚çº¢ (Highlight/Action) */
            --color-paper-light: #fffaf0;    /* å®£çº¸ç™½ (Soft Background) */
            --color-border-subtle: #d0d0d0;  /* æ·¡æè¾¹ */
            --color-card-bg: rgba(255, 255, 255, 0.95); /* åŠé€æ˜å¡ç‰‡ */
            
            /* ç„å¹»æ•ˆæœ */
            --shadow-float: 0 15px 45px rgba(0, 0, 0, 0.3); 
            --glow-gold: rgba(197, 140, 53, 0.8);          
            
            --font-main: 'FangSong', 'KaiTi', 'SimSun', serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--color-ink-deep); 
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><defs><pattern id="p" width="50" height="50" patternUnits="userSpaceOnUse"><rect width="50" height="50" fill="%23202a33" /><path d="M0,25 Q25,0 50,25 Q25,50 0,25 Z" stroke="%23384a5a" stroke-width="0.3" fill="none"/></pattern></defs><rect width="100%" height="100%" fill="url(%23p)" /></svg>');
            color: var(--color-ink-deep);
            margin: 0;
            
            /* æ‰‹æœºç«¯å¸ƒå±€ä¼˜åŒ–ï¼šç•™å‡ºè¾¹è·ï¼Œä»é¡¶éƒ¨å¼€å§‹å †å ï¼Œå…è®¸æ»šåŠ¨ */
            padding: 30px 15px; 
            display: flex;
            align-items: flex-start; /* å‚ç›´å¯¹é½ä»é¡¶éƒ¨å¼€å§‹ (è§£å†³å†…å®¹è¿‡é•¿çš„é—®é¢˜) */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            min-height: 100vh; /* å æ»¡æ•´ä¸ªè§†å£é«˜åº¦ */
            overflow-y: auto; 
            box-sizing: border-box;
        }

        .app-container {
            width: 100%; /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šå……åˆ†åˆ©ç”¨å®½åº¦ */
            max-width: 480px;
            margin: 0; /* è¾¹è·ç”± body padding æ§åˆ¶ */
            background: var(--color-card-bg);
            border-radius: 18px; 
            box-shadow: var(--shadow-float);
            padding: 35px;
            border: 2px solid var(--color-gold-main); 
            display: flex;
            flex-direction: column;
            position: relative;
            backdrop-filter: blur(2px); 
        }

        /* æ ‡é¢˜åŒº */
        header { 
            text-align: center;
            margin-bottom: 40px; 
            border-bottom: 2px solid var(--color-gold-main); 
            padding-bottom: 20px; 
        }
        h1 { 
            margin: 0;
            font-size: 2.5rem; 
            letter-spacing: 6px; 
            color: var(--color-ink-deep); 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        h1 span { 
            color: var(--color-cinnabar); 
            text-shadow: 0 0 8px var(--glow-gold); 
        }
        .subtitle { 
            font-size: 1.1rem; 
            color: var(--color-gold-main); 
            margin-top: 10px; 
            font-weight: bold;
            letter-spacing: 3px;
        }

        /* è¾“å…¥åŒº */
        .input-group { 
            margin-bottom: 30px; 
        }
        .input-group label { 
            display: block; 
            margin-bottom: 15px; 
            font-size: 1.05rem; 
            color: var(--color-ink-deep);
            text-align: center; 
            font-weight: bold;
            letter-spacing: 1px;
        }
        input[type="text"], input[type="number"] { 
            width: 100%;
            padding: 16px; 
            font-size: 1.1rem;
            border: 2px solid var(--color-ink-deep); 
            border-radius: 10px;
            box-sizing: border-box;
            background: var(--color-paper-light); 
            text-align: center;
            outline: none;
            transition: all 0.3s;
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.1);
        }
        input[type="text"]:focus, input[type="number"]:focus { 
            border-color: var(--color-gold-main); 
            box-shadow: 0 0 12px var(--glow-gold), inset 0 1px 5px rgba(0,0,0,0.2); 
        }
        .num-inputs {
            display: flex; gap: 12px;
            background: #eef1f3; 
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }
        .num-inputs input {
            padding: 12px; 
        }
        .input-hint {
            font-size: 0.85rem; color: #555; margin-top: 10px; text-align: center;
        }

        /* æŒ‰é’®é£æ ¼ */
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            letter-spacing: 3px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .btn-start { 
            background: linear-gradient(145deg, var(--color-cinnabar) 50%, #d44d4d);
            color: var(--color-paper-light);
            border-bottom: 5px solid var(--color-ink-deep); 
        }
        .btn-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(178, 34, 34, 0.6);
            border-bottom: 2px solid var(--color-ink-deep); 
        }
        .btn-start:active { 
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 5px solid var(--color-ink-deep); 
        }
        .btn-start:disabled { 
            background: #ccc; 
            border-bottom: 5px solid #999;
            cursor: not-allowed; 
            box-shadow: none; 
        }
        .btn-ai { 
            background: var(--color-ink-deep); 
            color: var(--color-gold-main); 
            margin-top: 20px;
            border: 2px solid var(--color-gold-main); 
        }
        .btn-ai:disabled { 
            background: #444;
            color: #aaa;
            border: 2px solid #555;
            cursor: not-allowed;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .btn-restart { 
            background: none; 
            border: 1px dashed var(--color-border-subtle); 
            color: #777; 
            margin-top: 40px;
            box-shadow: none;
            font-size: 1rem;
        }

        /* å¦è±¡å±•ç¤ºåŒº */
        .stage-area {
            min-height: 80px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 30px 0;
            background: var(--color-paper-light);
            border-radius: 15px;
            border: 3px double var(--color-gold-main); 
            box-shadow: 0 0 15px rgba(197, 140, 53, 0.3);
            padding: 25px 15px;
            flex-direction: column;
            text-align: center;
        }
        .gua-display {
            display: flex; 
            justify-content: center;
            gap: 20px; 
            margin-top: 15px;
        }
        .gua-block {
            padding: 10px 15px;
            border-radius: 8px;
            background: #fdfdfd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--color-border-subtle);
        }
        .gua-block p { 
            margin: 0; 
            font-weight: bold; 
            font-size: 0.95rem; 
            color: var(--color-gold-main); 
            letter-spacing: 1px;
        }
        .yao-line {
            font-family: 'Courier New', monospace; 
            font-size: 1.8rem; 
            line-height: 1.3;
            font-weight: 900;
            color: var(--color-ink-deep);
        }
        .yao-line.dong {
            color: var(--color-cinnabar); 
            text-shadow: 0 0 7px rgba(178, 34, 34, 0.6); 
        }

        /* ç»“æœå¡ç‰‡ */
        .result-card {
            padding: 30px;
            border-radius: 15px;
            background: var(--color-paper-light);
            border: 3px ridge var(--color-gold-main); 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2), 0 0 20px var(--glow-gold);
        }
        .card-title { 
            text-align: center; 
            color: var(--color-cinnabar); 
            font-size: 1.8rem; 
            margin-bottom: 25px;
            letter-spacing: 4px;
            font-weight: 900; 
            border-bottom: 1px dashed var(--color-border-subtle);
            padding-bottom: 10px;
        }
        .meta-info { 
            font-size: 1rem; 
            color: #555; 
            margin-bottom: 25px; 
            line-height: 2; 
            text-align: left;
            padding: 10px 20px;
            border-left: 5px solid var(--color-gold-main); 
            background: #f7f7f7;
            border-radius: 8px;
        }

        /* AI è§£è¯»å†…å®¹ */
        .ai-content { 
            border-top: 2px dashed var(--color-gold-main); 
            padding-top: 30px; 
            margin-top: 30px; 
            line-height: 2; 
            font-size: 1.05rem;
            color: var(--color-ink-deep);
        }
        .ai-content h3 { 
            color: var(--color-cinnabar); 
            font-size: 1.3rem; 
            margin-top: 2em; 
            margin-bottom: 1em; 
            border-left: 5px solid var(--color-cinnabar); 
            padding-left: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>å¿ƒæ˜“<span>ç¥æ•°</span></h1>
        <div class="subtitle">é“æ³•è‡ªç„¶</div>
    </header>

    <div id="setupView">
        <div class="input-group">
            <label for="question">ğŸ™ è™”å¿ƒé»˜å¿µæ‰€é—®ä¹‹äº‹ï¼Œç„¶åè¾“å…¥ï¼š</label>
            <input type="text" id="question" placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥æŠ•èµ„æˆè´¥å¦‚ä½•ï¼Ÿ">
        </div>

        <div class="input-group">
            <label>ğŸ”¢ è¯·è¾“å…¥èµ·å¦ä¸‰æ•°ï¼ˆä»»æ„æ­£æ•´æ•°ï¼‰ï¼š</label>
            <div class="num-inputs">
                <input type="number" id="numUp" placeholder="ä¸Šå¦æ•°" min="1" max="999" required style="flex: 1;">
                <input type="number" id="numLow" placeholder="ä¸‹å¦æ•°" min="1" max="999" required style="flex: 1;">
                <input type="number" id="numDong" placeholder="åŠ¨çˆ»æ•°" min="1" max="999" required style="flex: 1;">
            </div>
            <div class="input-hint">
                <p style="margin: 0;">ä»¥å¿ƒæ‰€æ„Ÿåº”ä¹‹æ•°ä¸ºå‡†ï¼Œä¸‡ç‰©çš†å¯èµ·å¦ã€‚</p>
            </div>
        </div>

        <button class="btn btn-start" id="calculateBtn" onclick="startMeiHua()">å¼€å§‹å åœï¼Œæ´å¯Ÿå¤©æœº</button>
    </div>

    <div id="resultView" style="display: none;">
        <div class="result-card">
            <div class="card-title">âœ¨ æ˜“ç†ç²¾å¾®ï¼Œç¥æœºè§£è¯­ âœ¨</div>
            <div class="meta-info" id="cardMeta"></div>
            
            <div class="stage-area">
                <div style="font-weight: bold; color: var(--color-gold-main); font-size: 1.1rem;">ã€ä¸‰æ˜“ä¹‹è±¡ã€‘</div>
                <div class="gua-display" id="guaDisplay">
                    </div>
                <div id="dongYaoInfo" style="margin-top: 15px; font-weight: bold; color: var(--color-cinnabar);"></div>
            </div>
            
            <div class="ai-content" id="aiOutput">
                <div style="text-align:center; color:#777; font-size: 1.1rem;">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå¯åŠ¨ AI åœç­®ä¹‹èƒ½...</div>
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-ai" id="aiBtn" onclick="callGeminiAI()" disabled>ğŸ¤– è¯·æ±‚ AI å¤§å¸ˆè§£å¦</button>
                </div>
            </div>
        </div>
        
        <div style="text-align:center;">
            <button class="btn btn-restart" onclick="location.reload()">é‡æ–°èµ·å¦ (å¿ƒå¿µè¯šåˆ™çµ)</button>
        </div>
    </div>
</div>

<script>
    // --- Gemini API é…ç½® (æ²¿ç”¨æ‚¨çš„ Worker URL) ---
    const GEMINI_ENDPOINT = "https://t6.tk709054540.workers.dev"; 


    
    // --- æ ¸å¿ƒé…ç½®ï¼šå…«å¦ä¿¡æ¯ ---
    const CFG = {
        EIGHT_GUA: ['å¤', 'è‰®', 'å', 'éœ‡', 'å·½', 'ç¦»', 'å…‘', 'ä¹¾'], 
        GUA_INFO: {
            'ä¹¾': { name: 'ä¹¾', symbol: 'â˜°', wuxing: 'é‡‘', number: 1, structure: '111', bits: [1, 1, 1] },
            'å…‘': { name: 'å…‘', symbol: 'â˜±', wuxing: 'é‡‘', number: 2, structure: '011', bits: [1, 1, 0] },
            'ç¦»': { name: 'ç¦»', symbol: 'â˜²', wuxing: 'ç«', number: 3, structure: '101', bits: [1, 0, 1] },
            'éœ‡': { name: 'éœ‡', symbol: 'â˜³', wuxing: 'æœ¨', number: 4, structure: '001', bits: [1, 0, 0] },
            'å·½': { name: 'å·½', symbol: 'â˜´', wuxing: 'æœ¨', number: 5, structure: '110', bits: [0, 1, 1] },
            'å': { name: 'å', symbol: 'â˜µ', wuxing: 'æ°´', number: 6, structure: '010', bits: [0, 1, 0] },
            'è‰®': { name: 'è‰®', symbol: 'â˜¶', wuxing: 'åœŸ', number: 7, structure: '100', bits: [0, 0, 1] },
            'å¤': { name: 'å¤', symbol: 'â˜·', wuxing: 'åœŸ', number: 8, structure: '000', bits: [0, 0, 0] }
        },
        YAO_SYMBOL: {
            '1': 'â”â”â”', 
            '0': 'â”ã€€â”', 
        }
    };
    
    let state = { data: {} };

    // --- æ¢…èŠ±æ˜“æ•°èµ·å¦ä¸»å‡½æ•° ---
    function startMeiHua() {
        try {
            document.getElementById('aiBtn').disabled = true;

            const q = document.getElementById('question').value.trim();
            const numUp = Math.abs(parseInt(document.getElementById('numUp').value));
            const numLow = Math.abs(parseInt(document.getElementById('numLow').value));
            const numDong = Math.abs(parseInt(document.getElementById('numDong').value));

            if (!q || isNaN(numUp) || isNaN(numLow) || isNaN(numDong) || numUp < 1 || numLow < 1 || numDong < 1) {
                alert("è¯·è™”è¯šè¾“å…¥æ‰€é—®é—®é¢˜ï¼Œå¹¶å®Œæ•´è¾“å…¥ä¸‰ä¸ªå¤§äº0çš„èµ·å¦æ•°å­—ã€‚");
                return;
            }

            const upGuaIndex = (numUp - 1) % 8; 
            const lowGuaIndex = (numLow - 1) % 8; 
            const dongYao = (numUp + numLow + numDong - 1) % 6; 
            
            const upGuaName = CFG.EIGHT_GUA[upGuaIndex];
            const lowGuaName = CFG.EIGHT_GUA[lowGuaIndex];

            const mainGua = getHexagramInfo(upGuaName, lowGuaName);
            const interGua = getInterGuaInfo(mainGua.structure);
            const changeGua = getChangeGuaInfo(mainGua.structure, dongYao);

            let dateStr = "";
            try { 
                // lunar-javascript ç¡®ä¿åŠ è½½æˆåŠŸ
                const l = Solar.fromDate(new Date()).getLunar();
                dateStr = l.getYearInGanZhi() + "å¹´" + l.getMonthInGanZhi() + "æœˆ" + l.getDayInGanZhi() + "æ—¥";
            } catch(e) { 
                dateStr = (new Date()).toLocaleDateString('zh-CN');
            }

            state.data = {
                q: q,
                d: dateStr,
                n: `${numUp}, ${numLow}, ${numDong}`,
                main: mainGua,
                inter: interGua,
                change: changeGua,
                dong: dongYao + 1 // 1åˆ°6çˆ»
            };

            document.getElementById('setupView').style.display = 'none';
            document.getElementById('resultView').style.display = 'block';
            updateResultView();
            
            // æˆåŠŸèµ·å¦åï¼Œå¯ç”¨AIè§£å¦æŒ‰é’®
            document.getElementById('aiBtn').disabled = false; 

        } catch(e) {
            console.error("æ¢…èŠ±èµ·å¦åŠŸèƒ½å‡ºé”™:", e);
            alert("èµ·å¦åŠŸèƒ½å‡ºç°å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–æ§åˆ¶å°ã€‚é”™è¯¯è¯¦æƒ…: " + e.message);
        }
    }

    // --- æ›´æ–°ç»“æœå±•ç¤ºåŒº (æ— å˜åŒ–) ---
    function updateResultView() {
        const d = state.data;
        
        document.getElementById('cardMeta').innerHTML = `
            <strong>æ‰€é—®ï¼š</strong>${d.q}<br>
            <strong>èµ·å¦æ—¶é—´ï¼š</strong>${d.d}<br>
            <strong>èµ·æ•°ï¼š</strong>${d.n}<br>
            <strong>ä¸»å¦ï¼š</strong>${d.main.up.name}${d.main.low.name} (${d.main.up.wuxing}ä¸${d.main.low.wuxing})
        `;

        const yaoNames = ['åˆ', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'ä¸Š'];
        document.getElementById('dongYaoInfo').innerHTML = `
            åŠ¨çˆ»ä½äº${yaoNames[d.dong - 1]}çˆ»ï¼šæ­¤ä¸ºå¦å˜ä¹‹æœºã€‚
        `;

        const mainGuaLines = d.main.structure.split('');
        const changeGuaLines = d.change.structure.split(''); 
        
        let mainHtml = '<div class="gua-block"><p>ä¸»å¦ (æœ¬)</p>';
        for (let i = 5; i >= 0; i--) {
            const isDong = i === (d.dong - 1);
            const lineClass = isDong ? 'yao-line dong' : 'yao-line';
            const mainSymbol = CFG.YAO_SYMBOL[mainGuaLines[i]];
            const yaoIndexText = ['åˆ', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'ä¸Š'][i];
            mainHtml += `<div class="${lineClass}">${mainSymbol} <span style="font-size:0.7em; color:#888;">${yaoIndexText}</span></div>`;
        }
        mainHtml += `</div>`;

        let changeHtml = '<div class="gua-block"><p>å˜å¦ (ä¹‹)</p>';
        for (let i = 5; i >= 0; i--) {
            const isDong = i === (d.dong - 1);
            const lineClass = isDong ? 'yao-line dong' : 'yao-line';
            const changeSymbol = CFG.YAO_SYMBOL[changeGuaLines[i]];
            changeHtml += `<div class="${lineClass}">${changeSymbol}</div>`;
        }
        changeHtml += `</div>`;

        const interStructure = d.inter.structure;
        let interHtml = `<div class="gua-block"><p>äº’å¦ (ä¸­ç›˜)</p>
            <div style="margin-top: 5px;">
                <div class="yao-line">${CFG.YAO_SYMBOL[interStructure[5]]}</div>
                <div class="yao-line">${CFG.YAO_SYMBOL[interStructure[4]]}</div>
                <div class="yao-line">${CFG.YAO_SYMBOL[interStructure[3]]}</div>
                <div style="height: 5px; border-bottom: 1px dotted #888; margin: 3px 0;"></div>
                <div class="yao-line">${CFG.YAO_SYMBOL[interStructure[2]]}</div>
                <div class="yao-line">${CFG.YAO_SYMBOL[interStructure[1]]}</div>
                <div class="yao-line">${CFG.YAO_SYMBOL[interStructure[0]]}</div>
            </div>
            <p style="font-size:0.8em; color:#555; margin-top:5px;">${d.inter.up.name}${d.inter.low.name}</p>
        </div>`;


        document.getElementById('guaDisplay').innerHTML = `
            ${mainHtml}
            ${interHtml}
            ${changeHtml}
        `;
    }


    // --- AI è§£å¦å‡½æ•° ---
    async function callGeminiAI() {
        const btn = document.getElementById('aiBtn');
        const out = document.getElementById('aiOutput');
        const d = state.data;
        
        btn.disabled = true;
        btn.innerText = "â³ AI å¤§å¸ˆæ­£åœ¨æ¨æ¼”å¤©æœºï¼Œè¯·ç¨å€™...";
        out.innerHTML = `<div style='text-align:center; color:${getComputedStyle(document.documentElement).getPropertyValue('--color-gold-main').trim()};'>ç¥æœºæ¨æ¼”ä¸­ï¼Œè¯·ç¨å€™...</div>`;
        
        // æ ¸å¿ƒæç¤ºè¯ï¼šå¼•å¯¼ Gemini æ‰®æ¼”æ¢…èŠ±æ˜“æ•°å¤§å¸ˆ 
        const prompt = `ä½ æ˜¯ä¸“ä¸šçš„æ¢…èŠ±æ˜“æ•°å¤§å¸ˆï¼Œç²¾é€šé‚µé›çš„ã€Šæ¢…èŠ±æ˜“æ•°ã€‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æä¾›çš„å¦è±¡ä¿¡æ¯å’Œé—®é¢˜ï¼Œè¿›è¡Œç²¾ç¡®çš„å æ–­å’Œåˆ†æã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¨ç®—å¹¶æ ¼å¼åŒ–è¾“å‡ºï¼ŒåŠ¡å¿…ä¿è¯ä¸“ä¸šã€æƒå¨å’Œæ˜“æ‡‚ï¼š

é—®é¢˜ï¼š${d.q}
èµ·å¦ä¿¡æ¯ï¼šæ—¶é—´ï¼š${d.d}ï¼Œèµ·æ•°ï¼š${d.n}
ä¸»å¦ï¼ˆæœ¬å¦ï¼‰ï¼š${d.main.up.name}${d.main.low.name}å¦
äº’å¦ï¼š${d.inter.up.name}${d.inter.low.name}å¦
å˜å¦ï¼ˆä¹‹å¦ï¼‰ï¼š${d.change.up.name}${d.change.low.name}å¦
åŠ¨çˆ»ï¼šç¬¬${d.dong}çˆ»

### 1. æ˜“ç†ä½“ç”¨åˆ†æï¼ˆåˆ¤æ–­å‰å‡¶ä¹‹æºï¼‰

- **ä½“å¦**ï¼ˆé—®äº‹ä¸»ä½“ï¼Œä¾åŠ¨çˆ»å®šä½“ç”¨ï¼‰ä¸**ç”¨å¦**ï¼ˆæ‰€é—®ä¹‹äº‹/å®¢ä½“ï¼‰ã€‚
- åˆ†æä½“ç”¨å¦çš„äº”è¡Œç”Ÿå…‹ï¼ˆ${d.main.up.name}å±${d.main.up.wuxing}ï¼Œ${d.main.low.name}å±${d.main.low.wuxing}ï¼‰ã€‚
- åŠ¨çˆ»åœ¨ä½“ç”¨å¦ä¸­çš„ä½ç½®å’Œå˜åŒ–ï¼Œåˆ¤æ–­å…¶å¯¹å‰å‡¶çš„å½±å“ã€‚

### 2. å‰å‡¶æ–­è¯­ä¸è¯¦é‡Š

- ç›´æ¥ç»™å‡ºå åœç»“è®ºï¼ˆ**å¤§å‰/å‰/å¹³/å‡¶/å¤§å‡¶**ï¼‰ã€‚
- ç»“åˆä¸»å¦ä¹‹ç†ï¼ˆå¤©æ—¶ï¼‰ã€äº’å¦ä¹‹æƒ…ï¼ˆäººäº‹ï¼‰ã€å˜å¦ä¹‹åº”ï¼ˆç»“æœï¼‰ï¼Œè¯¦ç»†è§£é‡Šä½“ç”¨ç”Ÿå…‹å…³ç³»å’ŒåŠ¨çˆ»å˜åŒ–æ˜¯å¦‚ä½•å¾—å‡ºæ­¤ç»“è®ºçš„ã€‚

### 3. é“æ³•è‡ªç„¶ï¼Œè¡ŒåŠ¨æŒ‡å¼•

- æä¾›é€šä¿—æ˜“æ‡‚ã€å…·æœ‰å“²ç†æ€§çš„è¡ŒåŠ¨æŒ‡å¯¼å’Œå»ºè®®ï¼Œé˜æ˜è¶‹å‰é¿å‡¶ä¹‹é“ã€‚`; 
        
        try {
            // è¯·æ±‚å‘é€åˆ° Worker Endpoint
            const res = await fetch(GEMINI_ENDPOINT, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{role: "user", parts: [{text: prompt}]}],
                    generationConfig: {temperature: 1.0} 
                   })
            });
            const data = await res.json();
            
            if(res.status !== 200 || !data.candidates || data.candidates.length === 0) {
                 throw new Error(data.error?.message || `ä»£ç†è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${res.status}`);
            }
            
            const resultText = data.candidates[0].content.parts[0].text;
            out.innerHTML = typeof marked !== 'undefined' ? marked.parse(resultText) : resultText;
            btn.style.display = 'none';
        } catch(e) {
            // ã€é‡ç‚¹ä¼˜åŒ–ã€‘ä½¿ç”¨æ›´æ¸…æ™°çš„é”™è¯¯æç¤ºï¼ŒæŒ‡æ˜å¤–éƒ¨é—®é¢˜
            out.innerHTML = `<div style="color:var(--color-cinnabar); font-weight:bold;">âŒ æ¨ç®—å¤±è´¥ (ç½‘ç»œ/æœåŠ¡é”™è¯¯)ï¼š<br>è¯·æ£€æŸ¥æ‚¨çš„æ‰‹æœºç½‘ç»œè¿æ¥ï¼Œå¹¶ç¡®è®¤ Worker URL æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚é”™è¯¯è¯¦æƒ…: ${e.message}</div>`;
            btn.innerText = "âŒ é‡æ–°è¯·æ±‚"; btn.disabled = false;
            console.error("AIè§£å¦é”™è¯¯:", e);
        }
    }


    // --- æ ¸å¿ƒè¾…åŠ©å‡½æ•°ï¼ˆæ— å˜åŒ–ï¼‰ ---

    function getHexagramInfo(upName, lowName) {
        const upGua = CFG.GUA_INFO[upName];
        const lowGua = CFG.GUA_INFO[lowName];
        const structure = lowGua.structure + upGua.structure; 
        return {
            up: upGua,
            low: lowGua,
            structure: structure,
            name: upName + lowName
        };
    }

    function getInterGuaInfo(mainStructure) {
        const structure = mainStructure.split(''); 
        const lowInterBits = [structure[1], structure[2], structure[3]]; 
        const upInterBits = [structure[2], structure[3], structure[4]]; 

        const getGuaByBits = (bits) => {
            const str = bits.join('');
            return Object.values(CFG.GUA_INFO).find(g => g.structure === str);
        };

        const upInter = getGuaByBits(upInterBits);
        const lowInter = getGuaByBits(lowInterBits);

        const interStructure = lowInterBits.join('') + upInterBits.join('');

        return {
            up: upInter,
            low: lowInter,
            structure: interStructure,
            name: upInter.name + lowInter.name
        };
    }

    function getChangeGuaInfo(mainStructure, dongYaoIndex) {
        let changeStructure = mainStructure.split('');
        
        changeStructure[dongYaoIndex] = changeStructure[dongYaoIndex] === '1' ? '0' : '1'; 
        
        const finalStructure = changeStructure.join('');
        
        const upChangeBits = [changeStructure[3], changeStructure[4], changeStructure[5]];
        const lowChangeBits = [changeStructure[0], changeStructure[1], changeStructure[2]];
        
        const getGuaByBits = (bits) => {
            const str = bits.join('');
            return Object.values(CFG.GUA_INFO).find(g => g.structure === str);
        };

        const upChange = getGuaByBits(upChangeBits);
        const lowChange = getGuaByBits(lowChangeBits);

        return {
            up: upChange,
            low: lowChange,
            structure: finalStructure,
            name: upChange.name + lowChange.name
        };
    }


    window.onload = function() {
        document.getElementById('calculateBtn').disabled = false;
    };
</script>
</body>
</html>